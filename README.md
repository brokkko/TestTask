# TestTask
Требуется создать веб сервис для валидации сотовых телефонов.

Дано:
* Веб Сервис будет использоваться бэкендом какой-то системы и не будет доступен
напрямую из фронта
* Цель веб сервиса - валидировать телефон, при помощи отправки по SMS
случайного кода и последующей проверки его. Код не должен быть длинным
(нужно, чтобы он был 4-6 цифр)
* Считаем, что сервису доступен компонент, который умеет отправлять смс. Для
целей задания достаточно, чтобы этот компонент просто писал текст и адрес в
консоль
* Сервису не нужно работать с persistent store, достаточно все держать в памяти
  
Сервис нужно спроектировать, реализовать и документировать его REST запросы. Что хочется от этого сервиса:
* Исключить валидацию телефона пользователем, которому телефон не принадлежит. Несмотря на любые его действия.
* Исключить ситуации, когда в результате сделанной им ошибки, пользователь вынужден обращаться в службу поддержки и не может более провалидировать телефон самостоятельно.
* Минимизировать возможности третьего лица, знающего мой телефон, создать мне неудобства при работе с системой

## Запуск
Необходимо запустить сначала модуль sms-suplier, а после него модуль cellphone-validator.

## Модуль cellphone-validator
В данном модуле реализован сервис для валидации сотовых телефонов. Все его REST запросы были задокументированы.

Контроллер обрабатывает два пользовательских запроса:
1) Post запрос **sendCode**, который по номеру телефона создает новый объект для верификации номера телефона. При успешном выполнении будет отправлено сообщение на телефон через модуль sms-suplier (в данной реализации сервис из модуля sms-suplier выведет в консоль номер телефона и код, который был бы отправлен на телефон пользователя).
2) Post запрос **verifyCode**, который проверяет валидность полученного кода. При успешной проверке будет получает статус 200.

Был реализован **обработчик исключений**. Таким образом, обработка ошибок была вынесена в отдельный контроллер. Выделяются следующие основные кастомные исключения:
* InvalidPhoneNumberException - возникает после проверки номера через валидатор номеров, если номер составлен некорректно.
* InvalidVerificationCodeException - возникает в случае, когда код верификации истек или же когда код верификации номера телефона не совпадает с тем, что лежит в storage.
* MaxVerificationAttemptsReachedException - возникает, когда пользователь больше 3-х раз ввел неправильный код верификации. Каждая неверная попытка проверки кода подсчитывается, чтобы избежать перебора.
* PhoneNumberNotFoundException - возникает, кода пользователь запрашивает проверку кода верификации по номеру телефона, которого нет в storage.
* SMSLimitReachedException - возникает, когда происходит запрос создания нового кода для одного и того же номера телефона в течении одной минуты. Время жизни созданного кода равно 5 минут, таким образом, запросить новый код по номеру телефона, у которого код был создан меньше минуты назад, нельзя.

**Валидация номера** через регулярное выражение. Чтобы избежать сохранение в storage номеров, которые по своей структуре ими не являются, используется метод валидации номеров перед сохранением. Этот метод вернет true для телефонных номеров, которые начинаются со знака «+», за которым следуют от 6 до 14 цифр. Цифры могут быть разделены пробелами.

**Защита** операции сравнения двух кодов **от атаки Timing Attack**. Если использовать сравнение строк, то злоумышленник может подобрать правильный код, анализируя время ответа сервера. Поэтому был создан метод, который тратит одинаковое количество времени на сравнение двух строк не зависимо от того, какое количество первых символов совпало.

Был реализован **сервис хранения данных**. Все данные в нем хранятся в ConcurrentHashMap, где номер телефона - это ключ, а VerificationData - значение. В данном сервисе реализован запланированный исполнитель (SheduledExecutorServcice), который каждую минут проверяет наполнение HashMap и удаляет все пары с истекшими кодами верификации.

Был реализован **сервис валидации данных**. В нем происходит обработка всех ситуаций и работа со storage сервисом.

Также были написаны **тесты** для сервисов данного модуля.

## Модуль sms-suplier
В данном модуле реализован сервис, который выводит в консоль номер телефона и код, который он отправил бы на телефон пользователя.

## Ручные тесты в Postman
### Пример отправки корректного запроса на создание кода верификации:

![image](https://github.com/brokkko/TestTask/assets/71688733/7f88f6b8-4cce-4541-8e03-8f8b0f7e43ca)

### При отправки корректного запроса сервер перенаправляет на модуль отправки сообщений на телефон созданный код верификации:

![image](https://github.com/brokkko/TestTask/assets/71688733/cd84063b-219d-4987-9525-3968c43ea140)

### Пример неверно введенного кода верификации при проверке:

![image](https://github.com/brokkko/TestTask/assets/71688733/a9213367-217a-4f15-9683-03c5c8bb492c)

### Пример неверно введенного кода верификации при проверке более 2-х раз:

![image](https://github.com/brokkko/TestTask/assets/71688733/34d236b4-bd2f-4845-bf39-14fa758c2f6f)

### После того, как код верификации не был подтвержден более 2-х раз, он удаляется, следовательно, еще один запрос на подтверждение кода верификации не сможет найти такой номер:

![image](https://github.com/brokkko/TestTask/assets/71688733/4ce2b0eb-aea4-41d4-9e6e-2649ec152758)

### Пример отправки невалидного номера телефона при создании кода верификации:

![image](https://github.com/brokkko/TestTask/assets/71688733/4c082fdb-e4dc-4f93-bc4a-c8e934a6245a)

![image](https://github.com/brokkko/TestTask/assets/71688733/f20e1b82-03b4-43bd-b3eb-e38f46b56d35)



